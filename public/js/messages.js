function getMessages(){$.getJSON("ajax/conversation/"+conversationId+"/get",function(a){var b=$("#message-box .row:last-child").data("id"),c=$("#message-box");c.empty(),$.each(a,function(a,b){var d=b.own?" own":"";console.log(d),$message='<div class="row'+d+'" data-id="'+b.id+'"><div class="col-md-3"><p>'+b.sender.username+'</p></div><div class="col-md-9"><p class="text-right">'+b.content+"</p></div></div>",c.append($message)}),b!=c.find(".row:last-child").data("id")&&($curMsg=c.find(".row:last-child"),c.scrollTop($curMsg.offset().top-c.innerHeight()+c.scrollTop()+$curMsg.innerHeight()))})}function formatUser(a){if(a.loading)return a.text;var b=null!=a.img?a.img:"img/profile.png",c='<div class="selectbox-result row blocklink-wrapper persist-cols"><div class="col-md-12 blocklink user"><div class="row"><div class="col-md-4"><div class="profile-img"><img src="'+b+'" alt="'+a.text+'"></div></div><div class="col-md-8"><p class="name">'+a.text+"</p></div></div></div></div>";return c}function formatUserSelection(a){return a.text}function setTitle(){$.post($("#set-title").attr("action"),$("#set-title").serialize(),function(){$("h1").text($('#set-title input[name="title"]').val()).toggleClass("hidden"),$("#set-title").toggleClass("hidden")})}var messages=[];$(function(){$("#message-input").keydown(function(a){13!=a.keyCode||""==$(this).value||a.shiftKey||$(this).closest("form").submit()}).focus(),$("#user-find").select2({placeholder:"Find and invite friends/team-mates",ajax:{url:"ajax/me/find-recipients/"+conversationId,dataType:"json",delay:250,data:function(a){return{q:a.term,page:a.page}},processResults:function(a,b){return b.page=b.page||1,{results:a,pagination:{more:30*b.page<a.total_count}}},cache:!0},minimumInputLength:2,escapeMarkup:function(a){return a},templateResult:formatUser,templateSelection:formatUserSelection}),getMessages(),$("#send-message-form").submit(function(a){a.preventDefault(),""!=$("#message-input").val()&&$("#message-input").val()&&$.post($(this).attr("action"),$(this).serialize(),function(){$("#message-input").val(""),getMessages()})}),setInterval(function(){getMessages()},3e3),$("#add-recipients-form").submit(function(a){a.preventDefault(),$.post($(this).attr("action"),$(this).serialize(),function(a){a=JSON.parse(a),$(".recipients").empty(),$.each(a,function(a,b){var c=null==b.img?"img/profile.png":b.img;$recipient='<div class="col-md-1 blocklink" title="'+b.username+'"><div class="profile-img"><img src="'+c+'" alt="'+b.username+'"></div></div>',$(".recipients").append($recipient)}),$(".recipients").append('<div class="col-md-1 blocklink"><a href="" class="btn btn-primary" data-toggle="modal" data-target="#add-recipient"><i class="fa fa-plus"></i></a></div>')}),$("#add-recipient").modal("toggle")}),$("h1").click(function(){$(this).toggleClass("hidden"),$("#set-title").toggleClass("hidden")}),$(window).bind("beforeunload",function(){0==messages.length&&$.post(base_url+"ajax/conversation/"+conversationId+"/destroy-if-empty",{_token:window.Laravel.csrfToken,_method:"DELETE"})}),$("#set-title").submit(function(a){a.preventDefault(),setTitle()}),$("body").keydown(function(a){27==a.keyCode&&$("h1").hasClass("hidden")&&$("#set-title, h1").toggleClass("hidden")})});